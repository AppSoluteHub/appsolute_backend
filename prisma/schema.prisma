generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String           @id @default(uuid())
  fullName          String
  nickName          String?
  country           String?
  phone             String?
  gender            String?
  email             String           @unique
  password          String
  profileImage      String?
  role              Role             @default(GUEST)
  resetToken        String?
  verified          Boolean          @default(false)
  resetTokenExpires DateTime?
  totalScore        Int              @default(0)
  answered          Int?             @default(0)
  comments          Comment[]        @relation("UserComments")
  contributors      Contributor[]    @relation("UserContributors")
  likes             Like[]           @relation("UserLikes")
  unlikes           Unlike[]         @relation("UserunLikes")
  posts             Post[]           @relation("UserPosts")
  behavioralData    UserBehavior[]
  userTasks         UserTask[]
  orders            Order[]
  reviews           Review[]
  carts             Cart[]
  billingAddresses  BillingAddress[]
  payments          Payment[]
  aiImages          AiImage[]
  joined            DateTime?        @default(now())
  updatedAt         DateTime?        @default(now())
}

model Task {
  id          String         @id @default(uuid())
  title       String
  url         String
  imageUrl    String?
  description String?
  points      Int            @default(5)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  userTasks   UserTask[]
  questions   Question[]
  tags        TaskTag[] // many-to-many with Tag
  categories  TaskCategory[] // many-to-many with Category
}

model Question {
  id            Int      @id @default(autoincrement())
  taskId        String
  questionText  String
  options       String[]
  correctAnswer String

  task      Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userTasks UserTask[]
}

model UserTask {
  id          String   @id @default(uuid())
  userId      String
  taskId      String
  questionId  Int
  userAnswer  String
  isCorrect   Boolean  @default(false)
  scoreEarned Int      @default(0)
  answeredAt  DateTime @default(now())

  task     Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, taskId, questionId])
}

model Post {
  id               String             @id @default(uuid())
  title            String
  imageUrl         String?
  description      String?
  authorId         String
  contributors     String[]
  editorRole       String?
  isPublished      Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  comments         Comment[]          @relation("PostComments")
  contributorsList Contributor[]      @relation("PostContributors")
  likes            Like[]             @relation("PostLikes")
  unlikes          Unlike[]           @relation("PostunLikes")
  author           User               @relation("UserPosts", fields: [authorId], references: [id])
  tags             PostTag[] // many-to-many with Tag
  categories       PostCategoryLink[] // many-to-many with Category
}

model Contributor {
  id     String @id @default(uuid())
  userId String
  postId String
  post   Post   @relation("PostContributors", fields: [postId], references: [id])
  user   User   @relation("UserContributors", fields: [userId], references: [id])

  @@unique([postId, userId])
}

model Comment {
  id        String   @id @default(uuid())
  body      String
  authorId  String
  postId    String
  createdAt DateTime @default(now())

  parentId String?
  replies  Comment[] @relation("CommentReplies")
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  author   User      @relation("UserComments", fields: [authorId], references: [id])
  post     Post      @relation("PostComments", fields: [postId], references: [id])
  likes    Like[]    @relation("CommentLikes")
  unlikes  Unlike[]  @relation("CommentunLikes")
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  postId    String?
  commentId String?
  createdAt DateTime @default(now())
  post      Post?    @relation("PostLikes", fields: [postId], references: [id])
  user      User     @relation("UserLikes", fields: [userId], references: [id])
  comment   Comment? @relation("CommentLikes", fields: [commentId], references: [id])

  @@unique([userId, commentId])
  @@unique([userId, postId])
}

model Unlike {
  id        String   @id @default(uuid())
  userId    String
  postId    String?
  commentId String?
  createdAt DateTime @default(now())

  post    Post?    @relation("PostunLikes", fields: [postId], references: [id])
  user    User     @relation("UserunLikes", fields: [userId], references: [id])
  comment Comment? @relation("CommentunLikes", fields: [commentId], references: [id])

  @@unique([userId, commentId])
  @@unique([userId, postId])
}

model Content {
  id          String @id @default(uuid())
  contentUrl  String
  description String
  category    String
}

model Subscriber {
  id    String @id @default(uuid())
  email String @unique
}

enum Role {
  ADMIN
  GUEST
  SUPERADMIN
  EDITOR
  CONTRIBUTOR
  VIEWER
}

enum InteractionType {
  VIEW
  CLICK
  LIKE
  SHARE
  COMMENT
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  posts     PostTag[]
  tasks     TaskTag[]
  createdAt DateTime  @default(now())
}

model Category {
  id        String             @id @default(uuid())
  name      String             @unique
  posts     PostCategoryLink[]
  tasks     TaskCategory[]
  createdAt DateTime           @default(now())
}

model PostTag {
  id     String @id @default(uuid())
  postId String
  tagId  String

  post Post @relation(fields: [postId], references: [id])
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
}

model TaskTag {
  id     String @id @default(uuid())
  taskId String
  tagId  String

  task Task @relation(fields: [taskId], references: [id])
  tag  Tag  @relation(fields: [tagId], references: [id])

  @@unique([taskId, tagId])
}

model PostCategoryLink {
  id         String @id @default(uuid())
  postId     String
  categoryId String

  post     Post     @relation(fields: [postId], references: [id])
  category Category @relation(fields: [categoryId], references: [id])

  @@unique([postId, categoryId])
}

model TaskCategory {
  id         String @id @default(uuid())
  taskId     String
  categoryId String

  task     Task     @relation(fields: [taskId], references: [id])
  category Category @relation(fields: [categoryId], references: [id])

  @@unique([taskId, categoryId])
}

model Image {
  id       String @id @default(uuid())
  imageUrl String
}

model UserBehavior {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  interaction String
  page        String?
  device      String?
  timestamp   DateTime @default(now())
}

model Software {
  id          String   @id @default(uuid())
  title       String
  description String?
  downloadUrl String?
  category    String?
  bgColor     String?
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Product {
  id          String      @id @default(uuid())
  title       String
  description String
  price       Float
  image       String
  gallery     String[]
  colors      String[]
  sizes       String[]
  stock       Int
  weight      Float
  brand       String?
  sku         String      @unique
  category    String
  tags        String[]
  reviews     Review[]
  orderItems  OrderItem[]
  cartItems   CartItem[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  discount    Float?      @default(0)
}

model Order {
  id             String          @id @default(uuid())
  userId         String
  user           User            @relation(fields: [userId], references: [id])
  items          OrderItem[]
  total          Float
  shareToken     String?         @unique
  status         String          @default("PENDING")
  payment        Payment?        @relation("OrderPayment")
  billingAddress BillingAddress?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  vat            Float?
  discount       Float?
}

model OrderItem {
  id String @id @default(uuid())

  // relation to Order
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // relation to Product
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity Int
  price    Float
}

model Review {
  id             String   @id @default(uuid())
  rating         Int
  comment        String
  title          String
  isRecommending Boolean
  productId      String
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Cart {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  items    CartItem[]
  subtotal Float      @default(0)
  total    Float      @default(0)
  vat      Float      @default(0)
  discount Float      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CartItem {
  id String @id @default(uuid())

  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity Int
}

model BillingAddress {
  id       String  @id @default(uuid())
  orderId  String  @unique
  order    Order   @relation(fields: [orderId], references: [id])
  userId   String
  user     User    @relation(fields: [userId], references: [id])
  fullName String
  lastName String
  company  String?
  country  String
  state    String
  zip      String
  phone    String
  email    String
  address  String
  note     String?
}

model Payment {
  id        String        @id @default(uuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id])
  orderId   String        @unique
  order     Order         @relation("OrderPayment", fields: [orderId], references: [id])
  email     String
  amount    Float
  reference String        @unique
  status    PaymentStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

model AiImage {
  id                String   @id @default(uuid())
  prompt            String
  originalImageUrl  String
  generatedImageUrl String?
  createdAt         DateTime @default(now())
  status            String   @default("PENDING")
  userId            String
  user              User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
}

model QuizQuestion {
  id               Int     @id @default(autoincrement())
  number           Int     @unique // Re-added the number field
  question         String
  modelAnswer      String
  answeredByUserId String?
}

model Score {
  id        Int      @id @default(autoincrement())
  userId    String   @unique
  score     Int      @default(0)
  updatedAt DateTime @updatedAt
}

model QuizConfig {
  id                    Int @id @default(1)
  trials                Int @default(3)
  correctAnswersForSpin Int @default(5)
}
